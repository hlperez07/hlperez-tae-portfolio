name: ðŸ§ª QA Automation CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]

  pull_request:
    branches: [ main ]

  schedule:
    - cron: '0 2 * * *'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Select environment'
        required: true
        default: 'qa'
        type: choice
        options:
          - qa
          - prod

      test_type:
        description: 'Select test type'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - regression

env:
  NODE_VERSION: '18'

jobs:

  lint:
    name: ðŸ” Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Run TypeScript check
        run: npx tsc --noEmit
        continue-on-error: true

  test:
    name: ðŸ§ª ${{ github.event.inputs.environment || 'qa' }} - ${{ github.event.inputs.test_type || 'regression' }} - ${{ matrix.browser }}
    runs-on: ubuntu-latest
    needs: lint

    strategy:
      matrix:
        browser: [chromium, firefox, webkit]

    env:
      TEST_ENV: ${{ github.event.inputs.environment || 'qa' }}
      TEST_TYPE: ${{ github.event.inputs.test_type || 'regression' }}

    steps:

      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸŽ­ Install Playwright Browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: ðŸ§ª Run Playwright tests
        run: |
          echo "Running tests on environment: $TEST_ENV"
          echo "Test type: $TEST_TYPE"
          npx playwright test \
            --project=${{ matrix.browser }} \
            --grep "@$TEST_ENV.*@$TEST_TYPE"

      - name: ðŸ“Š Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: report-${{ matrix.browser }}-${{ env.TEST_ENV }}-${{ env.TEST_TYPE }}
          path: playwright-report/
          retention-days: 30

  deploy-report:
    name: ðŸ“Š Deploy Test Reports
    runs-on: ubuntu-latest
    needs: test
    if: always()

    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download all reports
        uses: actions/download-artifact@v4
        with:
          path: reports

      - name: ðŸ“ Generate dynamic index page
        run: |
          mkdir -p reports
          cat > reports/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>ðŸ§ª Test Reports - Henry Perez</title>
            <style>
              body { font-family: Arial; margin: 40px; background: #f4f4f4; }
              h1 { color: #111; }
              .grid { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 30px; }
              .card {
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                width: 250px;
              }
              .card a {
                display: inline-block;
                margin-top: 15px;
                padding: 8px 15px;
                background: #2563eb;
                color: white;
                text-decoration: none;
                border-radius: 4px;
              }
            </style>
          </head>
          <body>
            <h1>ðŸ§ª Henry Perez - Automation Reports</h1>
            <p>Environment-based execution with smoke/regression filtering</p>
            <div class="grid">
          EOF

          for dir in reports/*; do
            if [ -d "$dir" ]; then
              folder=$(basename "$dir")
              echo "<div class='card'><h3>$folder</h3><a href='$folder/index.html'>View Report â†’</a></div>" >> reports/index.html
            fi
          done

          echo "</div></body></html>" >> reports/index.html

      - name: ðŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports
          publish_branch: gh-pages
