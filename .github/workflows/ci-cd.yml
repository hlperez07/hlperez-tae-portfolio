name: ðŸ§ª QA Automation CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Test environment'
        required: true
        default: 'qa'
        type: choice
        options:
          - qa
          - prod

env:
  NODE_VERSION: '18'

jobs:
  lint:
    name: ðŸ” Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      - name: ðŸ” Run TypeScript compiler check
        run: npx tsc --noEmit
        continue-on-error: true

  test-qa-chrome:
    name: ðŸ§ª QA Tests - Chrome
    runs-on: ubuntu-latest
    needs: lint
    env:
      ENV: qa
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      - name: ðŸŽ­ Install Playwright Browsers
        run: npx playwright install --with-deps chromium
      - name: ðŸ§ª Run QA tests on Chrome
        run: ENV=qa npx playwright test --project=chromium --reporter=html,json,junit
      - name: ðŸ“Š Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-qa-chrome
          path: playwright-report/
          retention-days: 30

  test-prod-chrome:
    name: ðŸš€ PROD Smoke Tests - Chrome
    runs-on: ubuntu-latest
    needs: lint
    env:
      ENV: prod
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      - name: ðŸŽ­ Install Playwright Browsers
        run: npx playwright install --with-deps chromium
      - name: ðŸš€ Run PROD smoke tests on Chrome
        run: ENV=prod npx playwright test --grep @smoke --project=chromium
      - name: ðŸ“Š Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-prod-chrome
          path: playwright-report/
          retention-days: 30

  test-firefox:
    name: ðŸ§ª QA Tests - Firefox
    runs-on: ubuntu-latest
    needs: lint
    env:
      ENV: qa
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      - name: ðŸŽ­ Install Playwright Browsers
        run: npx playwright install --with-deps firefox
      - name: ðŸ§ª Run tests on Firefox
        run: ENV=qa npx playwright test --project=firefox
      - name: ðŸ“Š Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-firefox
          path: playwright-report/
          retention-days: 30

  test-webkit:
    name: ðŸ§ª QA Tests - Safari
    runs-on: ubuntu-latest
    needs: lint
    env:
      ENV: qa
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      - name: ðŸŽ­ Install Playwright Browsers
        run: npx playwright install --with-deps webkit
      - name: ðŸ§ª Run tests on WebKit
        run: ENV=qa npx playwright test --project=webkit
      - name: ðŸ“Š Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-webkit
          path: playwright-report/
          retention-days: 30

  deploy-report:
    name: ðŸ“Š Deploy Test Report
    runs-on: ubuntu-latest
    needs: [test-qa-chrome, test-prod-chrome, test-firefox, test-webkit]
    if: always()
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      - name: ðŸ“¥ Download QA Chrome report
        uses: actions/download-artifact@v4
        with:
          name: playwright-report-qa-chrome
          path: reports/qa-chrome
        continue-on-error: true
      - name: ðŸ“¥ Download PROD Chrome report
        uses: actions/download-artifact@v4
        with:
          name: playwright-report-prod-chrome
          path: reports/prod-chrome
        continue-on-error: true
      - name: ðŸ“¥ Download Firefox report
        uses: actions/download-artifact@v4
        with:
          name: playwright-report-firefox
          path: reports/firefox
        continue-on-error: true
      - name: ðŸ“¥ Download WebKit report
        uses: actions/download-artifact@v4
        with:
          name: playwright-report-webkit
          path: reports/webkit
        continue-on-error: true
      - name: ðŸ“ Create index page
        run: |
          mkdir -p reports
          cat > reports/index.html << 'EOF'
          <!DOCTYPE html>
          <html><head><title>Test Reports - Henry Perez</title>
          <style>body{font-family:Arial,sans-serif;margin:40px;background:#f5f5f5}h1{color:#333}.report-links{display:flex;gap:20px;margin-top:30px;flex-wrap:wrap}.card{background:white;padding:30px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);text-align:center;min-width:200px}.card h2{margin-top:0;color:#2563eb}.card a{display:inline-block;margin-top:15px;padding:10px 20px;background:#2563eb;color:white;text-decoration:none;border-radius:4px}.card a:hover{background:#1d4ed8}</style></head>
          <body><h1>ðŸ§ª Test Reports - Henry Perez</h1><p>Test execution results for all environments and browsers</p>
          <div class="report-links">
          <div class="card"><h2>QA - Chrome</h2><p>QA environment tests</p><a href="qa-chrome/index.html">View Report â†’</a></div>
          <div class="card"><h2>PROD - Chrome</h2><p>Production smoke tests</p><a href="prod-chrome/index.html">View Report â†’</a></div>
          <div class="card"><h2>Firefox</h2><p>Firefox browser tests</p><a href="firefox/index.html">View Report â†’</a></div>
          <div class="card"><h2>Safari</h2><p>WebKit browser tests</p><a href="webkit/index.html">View Report â†’</a></div>
          </div></body></html>
          EOF
      - name: ðŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports
          publish_branch: gh-pages
